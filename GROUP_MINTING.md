# Group Minting

This document contains the Group Mint flow, there are some requirements to be able to reproduce it:
- An Account with xDai
- A Gnosis Safe Account
- A Path extracted from the Pathfinder site:
- The Hub and GroupCurrencyToken Contracts addresses

## Gnosis Safe Account

A circles account is created with a Gnosis Safe Account associated, so we might use that account to test the minting but at the moment there is an issue which does not allow us to use it in the gnosis app.
In the future it might be solved so we will specify the steps to import this safe account anyway.

### How to obtain Gnosis Safe Account from Circles App

You need a trusted circles account, then:
- Go to https://circles.garden/settings
- Save the privateKey from the localStorage and the Profile Address (Gnosis Safe Account)
![](https://i.imgur.com/rfairJX.png)
- Import the pv key to metamask
- Then, go to https://gnosis-safe.io/app
- Load this Profile Address as an existing Safe Account

### How to add a new Gnosis Safe Account into the system

A workaround for the issue of using the autogenerated gnosis safe account, is to create a new safe and manually add it to the system through the signup method from the Hub Contract.

- Create a Gnosis Safe: https://gnosis-safe.io/app/welcome in the gnosis chain
- Then, create a New Transaction using the Hub Contract:
  - deployed at: https://blockscout.com/xdai/mainnet/address/0x29b9a7fBb8995b2423a71cC17cf9810798F6C543
  - call the signup method and accept the transaction 
  - this method would add the safe address into the circles system

![](https://i.imgur.com/9zO1eIM.png)

- Finally, we need to:
  - trust this safe address (using the circles app with an already existing user)
  - so we can create a path from this new user to a group currency

## PathFinder

To mint tokens from a group we need to find the different addresses where the system need to extract the CRC tokens to finally transfer into the group.
We can find that path using the pathfinder app from this site: https://chriseth.github.io/pathfinder/ for instance
- from the user: 0xB77d3948693B6dEE0F85184db515CE4910C21fe9
- to the group: 0x6bE718C566d5D25D350F72fFbcb01fAd46675C97

We get the following path:

![](https://i.imgur.com/2vy4FsS.png)

We need to save the transferThrough object from the console which are the actual parameters to be used in the Hub contract call.

```
["0xB77d3948693B6dEE0F85184db515CE4910C21fe9", "0x42cEDde51198D1773590311E2A340DC06B24cB37", "0x4a9aFfA9249F36fd0629f342c182A4e94A13C2e0"]
["0xB77d3948693B6dEE0F85184db515CE4910C21fe9", "0x42cEDde51198D1773590311E2A340DC06B24cB37", "0x4a9aFfA9249F36fd0629f342c182A4e94A13C2e0"]
["0x42cEDde51198D1773590311E2A340DC06B24cB37", "0x4a9aFfA9249F36fd0629f342c182A4e94A13C2e0", "0x6bE718C566d5D25D350F72fFbcb01fAd46675C97"]
["5000000000000000000", "5000000000000000000", "5000000000000000000"]
```

## Execute Minting

We need to create a batch transaction using the Gnosis TX Builder because there are 2 separated methods which represent the group minting operation:
- transferThrough from the Hub contract
- mint from the GroupCurrencyToken contract

If we don't run everything in a single tx, any user could mint the transferred tokens into the group instead of the expected user.

We can create the first transaction as the following image:

![](https://i.imgur.com/p7fALQp.png)

For the second transaction, we need to do the following:
- find the token address of the user
- to get the token, we need to call the hub method: userToToken using the user address
- the user address is the second last address from the third array: 0x4a9aFfA9249F36fd0629f342c182A4e94A13C2e0
- calling this method results in this address: 0x9699ec7d3aadcd4f5e27627a4dd9a47b2c309e03
- finally, we can create the mint parameters using the token and amount equals to the transferred amount: 5000000000000000000 in this case

Get token address Operation
![](https://i.imgur.com/QtTsUDN.png)

Mint Operation
![](https://i.imgur.com/ONiigbn.png)

## Expected Result

This is an example of the current transaction:
![](https://i.imgur.com/ekY5fb3.png)

The succedeed transaction: https://blockscout.com/xdai/mainnet/tx/0x583ab3a1ce20a6479e9b98cfe449d70b56cd907fed2bd8c0b328c9b221b43093


## References

- https://joincircles.net/faq/
- https://gnosis-safe.io/
- https://help.gnosis-safe.io/en/articles/4680071-transaction-builder
